<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake - Admin</title>
    <link rel="stylesheet" href="./style.css">
    <style>
        .admin-wrap {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }
        .admin-header h1 {
            font-size: 2em;
            text-transform: uppercase;
        }
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        .admin-tab-btn {
            background: #1a1a1a;
            border: 1px solid #444;
            color: #aaa;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .admin-tab-btn.active, .admin-tab-btn:hover {
            background: #fff;
            color: #000;
            border-color: #fff;
        }
        .admin-panel { display: none; }
        .admin-panel.active { display: block; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
        }
        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #fff;
        }
        .stat-card .stat-label {
            color: #888;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        /* Tables */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .admin-table th {
            background: #1a1a1a;
            color: #aaa;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 1px;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .admin-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #222;
            color: #ccc;
            vertical-align: middle;
        }
        .admin-table tr:hover td { background: #111; }
        .admin-table .user-name { color: #fff; font-weight: bold; }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-admin { background: #fff; color: #000; }
        .badge-banned { background: #e55; color: #fff; }
        .badge-active { background: #2a2a2a; color: #aaa; border: 1px solid #444; }
        .badge-processing { background: #f5a623; color: #000; }
        .badge-shipped { background: #4cd964; color: #000; }
        .badge-delivered { background: #007aff; color: #fff; }

        /* Action buttons */
        .action-btn {
            background: none;
            border: 1px solid #444;
            color: #ccc;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            text-transform: uppercase;
            transition: all 0.2s;
            margin-right: 5px;
        }
        .action-btn:hover { border-color: #fff; color: #fff; }
        .action-btn.danger { border-color: #e55; color: #e55; }
        .action-btn.danger:hover { background: #e55; color: #fff; }
        .action-btn.success { border-color: #4cd964; color: #4cd964; }
        .action-btn.success:hover { background: #4cd964; color: #000; }

        /* Order status select */
        .status-select {
            background: #1a1a1a;
            border: 1px solid #444;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .admin-loading {
            text-align: center;
            padding: 40px;
            color: #555;
        }
        .admin-error {
            text-align: center;
            padding: 40px;
            color: #e55;
        }
        .search-bar {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #444;
            color: #fff;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 0.95em;
            margin-bottom: 20px;
        }
        .search-bar:focus { outline: none; border-color: #888; }
    </style>
</head>
<body>
    <div class="nav">
        <ul>
            <li><a href="./index.html">Home</a></li>
            <li><a href="./shop.html">Shop</a></li>
            <li><a href="./collections.html">Collections</a></li>
            <li><a href="./about.html">About</a></li>
        </ul>
        <div class="nav-right">
            <span id="nav-auth"></span>
            <a href="./cart.html" class="cart-nav-link">Cart <span id="cart-count" class="cart-badge" style="display:none;">0</span></a>
        </div>
    </div>

    <div class="admin-wrap" id="admin-wrap">
        <p class="admin-loading">Verifying access...</p>
    </div>

    <div class="footer">
        <p>&copy; 2025 SNAKE. All rights reserved.</p>
    </div>

    <script type="module">
        import { auth, db } from "./js/firebase.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import "./js/auth.js";

        const wrap = document.getElementById('admin-wrap');
        let idToken = null;
        let allUsers = [];

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                wrap.innerHTML = '<p class="admin-error">Access denied. Please log in.</p>';
                return;
            }

            // Check admin status
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (!userDoc.exists() || !userDoc.data().isAdmin) {
                wrap.innerHTML = '<p class="admin-error">Access denied. Admin only.</p>';
                return;
            }

            idToken = await user.getIdToken();
            renderAdmin(userDoc.data());
        });

        function renderAdmin(adminData) {
            wrap.innerHTML = `
                <div class="admin-header">
                    <h1>Admin Panel</h1>
                    <span style="color:#888; font-size:0.9em;">Logged in as ${adminData.name}</span>
                </div>
                <div class="admin-tabs">
                    <button class="admin-tab-btn active" data-tab="overview">Overview</button>
                    <button class="admin-tab-btn" data-tab="users">Users</button>
                    <button class="admin-tab-btn" data-tab="orders">Orders</button>
                </div>

                <div id="tab-overview" class="admin-panel active">
                    <div class="stats-grid" id="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="stat-users">—</div><div class="stat-label">Total Users</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-orders">—</div><div class="stat-label">Total Orders</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-banned">—</div><div class="stat-label">Banned Users</div></div>
                    </div>
                </div>

                <div id="tab-users" class="admin-panel">
                    <input type="text" class="search-bar" id="user-search" placeholder="Search by name or email..." />
                    <div id="users-table-wrap"><p class="admin-loading">Loading users...</p></div>
                </div>

                <div id="tab-orders" class="admin-panel">
                    <div id="orders-table-wrap"><p class="admin-loading">Loading orders...</p></div>
                </div>
            `;

            // Tab switching
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                });
            });

            loadUsers();
        }

        async function loadUsers() {
            try {
                const res = await fetch('/api/admin-users', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                allUsers = data.users;
                updateStats();
                renderUsersTable(allUsers);
                renderOrdersTable(allUsers);

                // Search
                document.getElementById('user-search').addEventListener('input', (e) => {
                    const q = e.target.value.toLowerCase();
                    const filtered = allUsers.filter(u =>
                        u.name?.toLowerCase().includes(q) ||
                        u.email?.toLowerCase().includes(q)
                    );
                    renderUsersTable(filtered);
                });

            } catch (err) {
                document.getElementById('users-table-wrap').innerHTML = `<p class="admin-error">${err.message}</p>`;
            }
        }

        function updateStats() {
            const totalOrders = allUsers.reduce((sum, u) => sum + (u.orders?.length || 0), 0);
            const banned = allUsers.filter(u => u.banned).length;
            document.getElementById('stat-users').textContent = allUsers.length;
            document.getElementById('stat-orders').textContent = totalOrders;
            document.getElementById('stat-banned').textContent = banned;
        }

        function renderUsersTable(users) {
            const wrap = document.getElementById('users-table-wrap');
            if (users.length === 0) {
                wrap.innerHTML = '<p class="admin-loading">No users found.</p>';
                return;
            }

            wrap.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Joined</th>
                            <th>Orders</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(u => `
                            <tr>
                                <td class="user-name">${u.name || '—'}
                                    ${u.isAdmin ? '<span class="badge badge-admin">Admin</span>' : ''}
                                </td>
                                <td>${u.email || '—'}</td>
                                <td>${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '—'}</td>
                                <td>${u.orders?.length || 0}</td>
                                <td>
                                    ${u.banned
                                        ? '<span class="badge badge-banned">Banned</span>'
                                        : '<span class="badge badge-active">Active</span>'
                                    }
                                </td>
                                <td>
                                    ${!u.isAdmin ? `
                                        ${u.banned
                                            ? `<button class="action-btn success" onclick="handleUserAction('${u.uid}', 'unban')">Unban</button>`
                                            : `<button class="action-btn danger" onclick="handleUserAction('${u.uid}', 'ban')">Ban</button>`
                                        }
                                        <button class="action-btn danger" onclick="handleUserAction('${u.uid}', 'delete')">Delete</button>
                                    ` : '<span style="color:#555">—</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderOrdersTable(users) {
            const wrap = document.getElementById('orders-table-wrap');
            const allOrders = [];
            users.forEach(u => {
                (u.orders || []).forEach(order => {
                    allOrders.push({ ...order, userName: u.name, userEmail: u.email, userId: u.uid });
                });
            });

            if (allOrders.length === 0) {
                wrap.innerHTML = '<p class="admin-loading">No orders found.</p>';
                return;
            }

            // Sort by date descending
            allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));

            wrap.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Update</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allOrders.map(order => `
                            <tr>
                                <td style="font-family:monospace; font-size:0.8em;">${order.id}</td>
                                <td>
                                    <span class="user-name">${order.userName}</span><br>
                                    <span style="color:#666; font-size:0.8em;">${order.userEmail}</span>
                                </td>
                                <td>${order.date ? new Date(order.date).toLocaleDateString() : '—'}</td>
                                <td>${order.items?.map(i => `${i.title} x${i.quantity}`).join('<br>') || '—'}</td>
                                <td>${order.total || '—'}</td>
                                <td>
                                    <span class="badge badge-${order.status?.toLowerCase().replace(' ', '-') || 'active'}">
                                        ${order.status || 'Unknown'}
                                    </span>
                                </td>
                                <td>
                                    <select class="status-select" onchange="updateOrderStatus('${order.userId}', '${order.id}', this.value)">
                                        <option ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                                        <option ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                        <option ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                        <option ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Expose to inline handlers
        window.handleUserAction = async (userId, action) => {
            const confirmMsg = action === 'delete'
                ? 'Are you sure you want to permanently delete this account?'
                : action === 'ban' ? 'Ban this user?' : 'Unban this user?';

            if (!confirm(confirmMsg)) return;

            try {
                const res = await fetch('/api/admin-delete-user', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${idToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, action })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                alert(data.message);
                loadUsers(); // Refresh
            } catch (err) {
                alert('Error: ' + err.message);
            }
        };

        window.updateOrderStatus = async (userId, orderId, status) => {
            try {
                const res = await fetch('/api/admin-update-order', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${idToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, orderId, status })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
            } catch (err) {
                alert('Error updating order: ' + err.message);
            }
        };
    </script>
</body>
</html>
